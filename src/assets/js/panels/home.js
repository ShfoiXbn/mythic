"use strict";import{logger,database,changePanel}from"../utils.js";const{Launch:Launch,Status:Status}=require("minecraft-java-core"),{ipcRenderer:ipcRenderer}=require("electron"),launch=new Launch,pkg=require("../package.json"),dataDirectory=process.env.APPDATA||("darwin"==process.platform?`${process.env.HOME}/Library/Application Support`:process.env.HOME);class Home{static id="home";async init(config,news){this.config=config,this.news=await news,this.database=await(new database).init(),this.initNews(),this.initLaunch(),this.initStatusServer(),this.initBtn()}async initNews(){let news=document.querySelector(".news-list");if(this.news)if(this.news.length)for(let News of this.news){let date=await this.getdate(News.publish_date),blockNews=document.createElement("div");blockNews.classList.add("news-block"),blockNews.innerHTML=`\n                        <div class="news-header">\n                            <div class="header-text">\n                                <div class="title">${News.title}</div>\n                            </div>\n                            <div class="date">\n                                <div class="day">${date.day}</div>\n                                <div class="month">${date.month}</div>\n                            </div>\n                        </div>\n                        <div class="news-content">\n                            <div class="bbWrapper">\n                                <p>${News.content.replace(/\n/g,"</br>")}</p>\n                                <p class="news-author">Auteur,<span> ${News.author}</span></p>\n                            </div>\n                        </div>`,news.appendChild(blockNews)}else{let blockNews=document.createElement("div");blockNews.classList.add("news-block","opacity-1"),blockNews.innerHTML='\n                    <div class="news-header">\n                        <div class="header-text">\n                            <div class="title">Aucun news n\'ai actuellement disponible.</div>\n                        </div>\n                    </div>\n                    <div class="news-content">\n                        <div class="bbWrapper">\n                            <p>Vous pourrez suivre ici toutes les news relative au serveur.</p>\n                        </div>\n                    </div>',news.appendChild(blockNews)}else{let blockNews=document.createElement("div");blockNews.classList.add("news-block","opacity-1"),blockNews.innerHTML='\n                <div class="news-header">\n                    <div class="header-text">\n                        <div class="title">Error.</div>\n                    </div>\n                </div>\n                <div class="news-content">\n                    <div class="bbWrapper">\n                        <p>Impossible de contacter le serveur des news.</br>Merci de vérifier votre configuration.</p>\n                    </div>\n                </div>'}}async initLaunch(){document.querySelector(".play-btn").addEventListener("click",(async()=>{let urlpkg=pkg.user?`${pkg.url}/${pkg.user}`:pkg.url,uuid=(await this.database.get("1234","accounts-selected")).value,account=(await this.database.get(uuid.selected,"accounts")).value,ram=(await this.database.get("1234","ram")).value,Resolution=(await this.database.get("1234","screen")).value,launcherSettings=(await this.database.get("1234","launcher")).value,playBtn=document.querySelector(".play-btn"),info=document.querySelector(".text-download"),progressBar=document.querySelector(".progress-bar");"<auto>"==Resolution.screen.width?screen=!1:screen={width:Resolution.screen.width,height:Resolution.screen.height};let opts={url:""===this.config.game_url||void 0===this.config.game_url?`${urlpkg}/files`:this.config.game_url,authenticator:account,timeout:1e4,path:`${dataDirectory}/${"darwin"==process.platform?this.config.dataDirectory:`.${this.config.dataDirectory}`}`,version:this.config.game_version,detached:"close-all"!==launcherSettings.launcher.close,downloadFileMultiple:30,loader:{type:this.config.loader.type,build:this.config.loader.build,enable:this.config.loader.enable},verify:this.config.verify,ignored:["loader",...this.config.ignored],java:!0,memory:{min:1024*ram.ramMin+"M",max:1024*ram.ramMax+"M"}};playBtn.style.display="none",info.style.display="block",launch.Launch(opts),launch.on("extract",(extract=>{console.log(extract)})),launch.on("progress",((progress,size)=>{progressBar.style.display="block",document.querySelector(".text-download").innerHTML=`Téléchargement ${(progress/size*100).toFixed(0)}%`,ipcRenderer.send("main-window-progress",{progress:progress,size:size}),progressBar.value=progress,progressBar.max=size})),launch.on("check",((progress,size)=>{progressBar.style.display="block",document.querySelector(".text-download").innerHTML=`Vérification ${(progress/size*100).toFixed(0)}%`,progressBar.value=progress,progressBar.max=size})),launch.on("estimated",(time=>{let hours=Math.floor(time/3600),minutes=Math.floor((time-3600*hours)/60),seconds=Math.floor(time-3600*hours-60*minutes);console.log(`${hours}h ${minutes}m ${seconds}s`)})),launch.on("speed",(speed=>{console.log(`${(speed/1067008).toFixed(2)} Mb/s`)})),launch.on("patch",(patch=>{console.log(patch),info.innerHTML="Patch en cours..."})),launch.on("data",(e=>{new logger("Minecraft","#36b030"),"close-launcher"===launcherSettings.launcher.close&&ipcRenderer.send("main-window-hide"),ipcRenderer.send("main-window-progress-reset"),progressBar.style.display="none",info.innerHTML="Demarrage en cours...",console.log(e)})),launch.on("close",(code=>{"close-launcher"===launcherSettings.launcher.close&&ipcRenderer.send("main-window-show"),progressBar.style.display="none",info.style.display="none",playBtn.style.display="block",info.innerHTML="Vérification",new logger("Launcher","#7289da"),console.log("Close")})),launch.on("error",(err=>{console.log(err)}))}))}async initStatusServer(){let nameServer=document.querySelector(".server-text .name"),serverMs=document.querySelector(".server-text .desc"),playersConnected=document.querySelector(".etat-text .text"),online=document.querySelector(".etat-text .online"),serverPing=await new Status(this.config.status.ip,this.config.status.port).getStatus();serverPing.error?serverPing.error&&(nameServer.textContent="Serveur indisponible",serverMs.innerHTML='<span class="red">Hors ligne</span>'):(nameServer.textContent=this.config.status.nameServer,serverMs.innerHTML=`<span class="green">En ligne</span> - ${serverPing.ms}ms`,online.classList.toggle("off"),playersConnected.textContent=serverPing.playersConnect)}initBtn(){document.querySelector(".settings-btn").addEventListener("click",(()=>{changePanel("settings")}))}async getdate(e){let date=new Date(e),year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate();return{year:year,month:["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"][month-1],day:day}}}export default Home;
