"use strict";const fs=require("fs"),{Microsoft:Microsoft,Mojang:Mojang}=require("minecraft-java-core"),{ipcRenderer:ipcRenderer}=require("electron");import{config,logger,changePanel,database,addAccount,accountSelect}from"./utils.js";import Login from"./panels/login.js";import Home from"./panels/home.js";import Settings from"./panels/settings.js";class Launcher{async init(){this.initLog(),console.log("Initializing Launcher..."),"win32"==process.platform&&this.initFrame(),this.config=await config.GetConfig().then((res=>res)),this.news=await config.GetNews().then((res=>res)),this.database=await(new database).init(),this.createPanels(Login,Home,Settings),this.getaccounts()}initLog(){document.addEventListener("keydown",(e=>{(e.ctrlKey&&e.shiftKey&&73==e.keyCode||123==e.keyCode)&&ipcRenderer.send("main-window-dev-tools")})),new logger("Launcher","#7289da")}initFrame(){console.log("Initializing Frame..."),document.querySelector(".frame").classList.toggle("hide"),document.querySelector(".dragbar").classList.toggle("hide"),document.querySelector("#minimize").addEventListener("click",(()=>{ipcRenderer.send("main-window-minimize")}));let maximized=!1,maximize=document.querySelector("#maximize");maximize.addEventListener("click",(()=>{ipcRenderer.send("main-window-maximize"),maximized=!maximized,maximize.classList.toggle("icon-maximize"),maximize.classList.toggle("icon-restore-down")})),document.querySelector("#close").addEventListener("click",(()=>{ipcRenderer.send("main-window-close")}))}createPanels(...panels){let panelsElem=document.querySelector(".panels");for(let panel of panels){console.log(`Initializing ${panel.name} Panel...`);let div=document.createElement("div");div.classList.add("panel",panel.id),div.innerHTML=fs.readFileSync(`${__dirname}/panels/${panel.id}.html`,"utf8"),panelsElem.appendChild(div),(new panel).init(this.config,this.news)}}async getaccounts(){let accounts=await this.database.getAll("accounts"),selectaccount=(await this.database.get("1234","accounts-selected"))?.value?.selected;if(accounts.length){for(let account of accounts)if(account=account.value,"Xbox"===account.meta.type){console.log(`Initializing Xbox account ${account.name}...`);let refresh_accounts,refresh_profile,refresh=await new Microsoft(this.config.client_id).refresh(account);if(refresh.error){this.database.delete(account.uuid,"accounts"),this.database.delete(account.uuid,"profile"),account.uuid===selectaccount&&this.database.update({uuid:"1234"},"accounts-selected"),console.error(`[Account] ${account.uuid}: ${refresh.errorMessage}`);continue}refresh_accounts={access_token:refresh.access_token,client_token:refresh.client_token,uuid:refresh.uuid,name:refresh.name,refresh_token:refresh.refresh_token,user_properties:refresh.user_properties,meta:refresh.meta},refresh_profile={uuid:refresh.uuid},this.database.update(refresh_accounts,"accounts"),this.database.update(refresh_profile,"profile"),addAccount(refresh_accounts),account.uuid===selectaccount&&accountSelect(refresh.uuid)}else if("Mojang"===account.meta.type){if(!account.meta.online){console.log(`Initializing Crack account ${account.name}...`),addAccount(account),account.uuid===selectaccount&&accountSelect(account.uuid);continue}if(!await Mojang.validate(account)){this.database.delete(account.uuid,"accounts"),account.uuid===selectaccount&&this.database.update({uuid:"1234"},"accounts-selected"),console.error(`[Account] ${account.uuid}: Token is invalid.`);continue}let refresh_accounts,refresh=await Mojang.refresh(account);if(console.log(`Initializing Mojang account ${account.name}...`),refresh.error){this.database.delete(account.uuid,"accounts"),account.uuid===selectaccount&&this.database.update({uuid:"1234"},"accounts-selected"),console.error(`[Account] ${account.uuid}: ${refresh.errorMessage}`);continue}refresh_accounts={access_token:refresh.access_token,client_token:refresh.client_token,uuid:refresh.uuid,name:refresh.name,user_properties:refresh.user_properties,meta:{type:refresh.meta.type,offline:refresh.meta.offline}},this.database.update(refresh_accounts,"accounts"),addAccount(refresh_accounts),account.uuid===selectaccount&&accountSelect(refresh.uuid)}else this.database.delete(account.uuid,"accounts"),account.uuid===selectaccount&&this.database.update({uuid:"1234"},"accounts-selected");if(!(await this.database.get("1234","accounts-selected")).value.selected){let uuid=(await this.database.getAll("accounts"))[0]?.value?.uuid;uuid&&(this.database.update({uuid:"1234",selected:uuid},"accounts-selected"),accountSelect(uuid))}if(0==(await this.database.getAll("accounts")).length)return changePanel("login"),void(document.querySelector(".preload-content").style.display="none");changePanel("home")}else changePanel("login");document.querySelector(".preload-content").style.display="none"}}(new Launcher).init();
